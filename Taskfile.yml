version: 3

vars:
  VERSION:
    sh: git describe --always --dirty --tags
  LOCAL_DB: postgres://default:default@localhost:5432/postgres?sslmode=disable

tasks:
  default:
    deps: [api]
    cmds:
      - ./api.exe
    sources:
      - api/**/*.go

  production:
    cmds:
      - ./api.exe

  api:
    cmds:
      - go build -o api.exe -ldflags="-X 'github.com/Southclaws/storyden/api/src/config.Version={{.VERSION}}'" ./api/
  api:test:
    cmds:
      - go test -p 1 -race ./api/...

  api:image:
    cmds:
      - docker build -t {{.DOCKER_IMAGE_TAG}} .

  # -
  # Code generation
  # -

  generate:
    deps: [generate:db, generate:swagger]

  generate:db:
    cmds:
      - go generate ./api/src/infra/db/...

  generate:swagger:
    cmds:
      - swag fmt --dir ./api
      - swag init --dir ./api --output ./api/src/interfaces/swagger

  # -
  # Database
  # -

  db:migrate:
    deps: [db:migrate:generate, db:migrate:run]

  db:migrate:generate:
    desc: Generate migrations from schema changes.
    cmds:
      - go run ./cmd/generate/main.go

  db:migrate:run:
    desc: Execute migrations against database.
    cmds:
      - go run ./cmd/migrate/main.go

  db:ui:
    cmds:
      - atlas schema inspect -d {{.LOCAL_DB}} -w
